<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
</head>
<style>
    #my-canvas {
        border: 1px solid #ababab;
        font-family: 'Indie Flower', cursive;
        color: blue;
    }

    #indir {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }
</style>
<body>
<h1>Oy pusulası fotoğrafı yapıcı</h1>
<p>
    Oy pusulası fotoğrafı isteyen işyerleri için, oy pusulası fotoğrafı yapıcı<br/>
<ul>
    <li>
        Oy vermek için pusulanın üzerine tıklayın.
    </li>
    <li>
        İsim yazmak için, isminizi yazdıktan sonra ismin görünmesini istediğiniz yere tıklayın
    </li>
    <li>
        Resme kimlik koymak için, kimlik yükledikten sonra kimliğin görünmesini istediğiniz yere tıklayın
    </li>
    <li>
        Baştan başlaya tıklayınca zemin değişir.
    </li>
</ul>
</p>
<button id="bastan">Baştan başla</button>
<a id="indir">İndir</a>
Kimlik Yüklemek için (İsteğe bağlı): <input type="file" id="imageLoader" name="imageLoader"/>
İsminiz (İsteğe bağlı): <input type="text" id="isim"/> <br/>
<br>
<canvas id="my-canvas" width="800" height="600"></canvas>
</body>
<script>

    function loadImage(src, onload) {
        // http://www.thefutureoftheweb.com/blog/image-onload-isnt-being-called
        var img = new Image();

        img.onload = onload;
        img.src = src;

        return img;
    }

    function main() {

        imagesLoaded += 1;

        if (imagesLoaded > 2) {
            var angle = Math.floor(Math.random() * 10);

            var select = Math.floor(Math.random() * 3);
            if (select == 0) {
                var oybackground = wood1;
            }
            else if (select == 1) {

                var oybackground = wood2;
            }
            else if (select == 2) {
                var oybackground = wood3;
            }
            else if (select == 3) {
                var oybackground = wood4;
            }

            console.log(select);


            // composite now
            ctx.rotate(5 * Math.PI / 180);
            ctx.drawImage(oybackground, -100, -100);
            ctx.rotate(-5 * Math.PI / 180);
            //ctx.globalAlpha = 0.5;
            ctx.save();
            ctx.shadowColor = '#555555'; // green for demo purposes
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.rotate(angle * Math.PI / 180);
            ctx.drawImage(img2, canvas.width / 2 - img2.width / 2, canvas.height / 2 - img2.height / 2 - 50);
            ctx.rotate(-angle * Math.PI / 180);

            ctx.restore();
        }
    }

    function handleImage(e) {
        var reader = new FileReader();
        reader.onload = function (event) {
            var img = new Image();
            img.onload = function () {
                kimlik = img;
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    }


    var imagesLoaded = 0;
    var canvas = document.getElementById("my-canvas");
    var ctx = canvas.getContext("2d");

    var tercih = loadImage('tercih.png', main);

    var wood1 = loadImage('wood1.jpg', main);
    var wood2 = loadImage('wood2.jpg', main);
    var wood3 = loadImage('wood3.jpg', main);
    var wood4 = loadImage('wood4.jpg', main);
    var img2 = loadImage('pusula.png', main);
    var papers = loadImage('paper.png', main);
    var kimlik = null;
    var kimlikResimde = false;
    var isimResimde = false;

    var secildi = false;


    document.addEventListener("DOMContentLoaded", function () {

        var imageLoader = document.getElementById('imageLoader');
        imageLoader.addEventListener('change', handleImage, false);

        canvas.addEventListener('click', function (evt) {

            var rect = canvas.getBoundingClientRect();
            var x = evt.clientX - rect.left;
            var y = evt.clientY - rect.top;

            console.log('x:' + x + ' y:' + y);
            var angle2 = Math.floor(Math.random() * 50);

            var isim = document.getElementById('isim').value;

            if (secildi == false) {
                // draw the image
                // since the context is rotated, the image will be rotated also
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle2 * Math.PI / 180);
                ctx.drawImage(tercih, 0, 0, 50, 50);
                ctx.restore();
                secildi = true;
            }
            else if (secildi == true && isim != '' && isimResimde == false) {
                // draw the image
                // since the context is rotated, the image will be rotated also
                ctx.save();
                ctx.translate(x, y);

                var angle3 = Math.floor(Math.random() * 10);
                ctx.rotate(angle3 * Math.PI / 180);

                ctx.save();
                ctx.shadowColor = '#555555'; // green for demo purposes
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                ctx.drawImage(papers, 0, 0, 300, 100);

                ctx.restore();

                ctx.font = '30px "Indie Flower"';
                var isim = document.getElementById('isim').value;
                ctx.fillStyle = "#284283";
                ctx.fillText(isim, 60, 60);
                ctx.restore();
                isimResimde = true;
            }
            else if (secildi == true && kimlik != null && kimlikResimde == false) {
                // draw the image
                // since the context is rotated, the image will be rotated also
                ctx.save();
                ctx.translate(x, y);

                var angle3 = Math.floor(Math.random() * 30);
                ctx.rotate(angle3 * Math.PI / 180);

                ctx.shadowColor = '#333333'; // green for demo purposes
                ctx.shadowBlur = 20;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                ctx.drawImage(kimlik, 0, 0, 332, 450);

                ctx.restore();
                kimlikResimde = true;
            }


        }, false);

        drawCanvas();
    });

    var bastan = document.getElementById("bastan");
    bastan.addEventListener('click', function (evt) {
        secildi = false;
        kimlikResimde = false;
        isimResimde = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawCanvas();
    });

    var indir = document.getElementById("indir");

    function downloadCanvas(link, canvasId, filename) {
        link.href = document.getElementById(canvasId).toDataURL();
        link.download = filename;
    }

    indir.addEventListener('click', function (evt) {
        downloadCanvas(this, 'my-canvas', 'oy.png');
    });

    function drawCanvas() {
        main();
    }

</script>
</html>