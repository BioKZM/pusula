<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Oy Pusulası Yapıcı</title>

    <!-- CSS Reset -->
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">

    <!-- You should properly set the path from the main file. -->
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower" rel="stylesheet">
    <meta property="og:title" content="Oy Pusulası Fotoğrafı Yapıcı"/>
    <meta property="og:image" content="https://midorikocak.github.io/pusula/og-image.png"/>
    <meta property="og:description" content="Oy pusulası fotoğrafı isteyen işyerleri için, oy pusulası fotoğrafı yapıcı"/>
    <meta property="og:url" content="https://midorikocak.github.io/pusula"/>
</head>
<style>
    @charset "utf-8";
    @font-face {
        font-family: 'AHundredMiles';
        src: url('AHundredMiles.ttf');
    }
    #my-canvas {
        border: 1px solid #ababab;
        font-family: 'AHundredMiles', 'Indie Flower', cursive;
        color: blue;
    }

    #indir {
        color: blue;
        text-decoration: underline;
        cursor: pointer;
    }
</style>
<body>
<h1>Oy pusulası fotoğrafı yapıcı</h1>
<a href="https://www.mynameismidori.com">Midori Kocak</a> tarafından HTML5 ve Javascript kullanılarak yazılmıştır. #HAYIR
<p>
    Oy pusulası fotoğrafı isteyen işyerleri için, oy pusulası fotoğrafı yapıcı<br/>
<ul>
    <li>
        Oy vermek için pusulanın üzerine tıklayın.
    </li>
    <li>
        İsim yazmak için, isminizi yazdıktan sonra ismin görünmesini istediğiniz yere tıklayın
    </li>
    <li>
        Resme kimlik koymak için, kimlik yükledikten sonra kimliğin görünmesini istediğiniz yere tıklayın
    </li>
    <li>
        Mobilden inmiyorsa ekran resmi alın.
    </li>
    <li>
        Baştan başlaya tıklayınca zemin değişir.
    </li>
</ul>
</p>
<button id="bastan">Baştan başla</button>
<a id="indir">İndir</a>
Kimlik Yüklemek için (İsteğe bağlı): <input type="file" id="imageLoader" name="imageLoader"/>
İsminiz (İsteğe bağlı): <input type="text" id="isim"/> <br/>
<br>
<canvas id="my-canvas" width="800" height="600"></canvas>
</body>
<script>
    var canvas = document.getElementById("my-canvas");
    var ctx = canvas.getContext("2d");
    var imgs = [], grab;
    /* x, y: coords. w, h: width, height.
     * angle: rotation around origin. drag: can we drag this? loadedImage: Image, drawFunc: update function */
    function Img(x, y, w, h, angle, drag, loadedImage){
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = h;
        this.angle = angle;
        this.drag = drag;
        this.loadedImage = loadedImage;
        this.drawFunc = function(){ console.log("no drawFunc set", this); };
        imgs.push(this);
    }

    function drawPlain(img){
        ctx.save();
        ctx.translate(img.x, img.y);
        ctx.rotate(img.angle);
        ctx.drawImage(img.loadedImage, 0, 0, img.w, img.h);
        ctx.restore();
    }

    function drawShadow(img, shadowColor, shadowBlur){
        ctx.save();
        ctx.translate(img.x, img.y);
        ctx.rotate(img.angle);
        ctx.shadowColor = shadowColor;
        ctx.shadowBlur = shadowBlur;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.drawImage(img.loadedImage, 0, 0, img.w, img.h);
        ctx.restore();
    }

    function rotatePoint(x, y, theta){
        var out = {};
        out.x = Math.cos(theta) * x - Math.sin(theta) * y;
        out.y = Math.sin(theta) * x + Math.cos(theta) * y;
        return out;
    }

    function loadImage(src, onload) {
        // http://www.thefutureoftheweb.com/blog/image-onload-isnt-being-called
        var img = new Image();

        img.onload = onload;
        img.src = src;

        return img;
    }

    function main() {
        imagesLoaded += 1;

        if (imagesLoaded > 4) {
            var angle = Math.floor(Math.random() * 10);

            var select = Math.floor(Math.random() * 3);
            if (select == 0) {
                var oybackground = wood1;
            }
            else if (select == 1) {
                var oybackground = wood2;
            }
            else if (select == 2) {
                var oybackground = wood3;
            }
            else if (select == 3) {
                var oybackground = wood4;
            }

            console.log(select);

            bg = new Img(-100, -100, oybackground.width, oybackground.height,
            			5*Math.PI/180, false, oybackground);
            bg.drawFunc = function(){ drawPlain(bg); };

            ballot = new Img(canvas.width/2 - img2.width/2, canvas.height/2 - img2.height/2 - 50,
            				img2.width, img2.height, angle*Math.PI/180, true, img2);
            ballot.drawFunc = function(){ drawShadow(ballot, '#555555', 10); }
        }
    }

    function handleImage(e) {
        var reader = new FileReader();
        reader.onload = function (event) {
            var img = new Image();
            img.onload = function () {
                kimlik = img;
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    }


    var imagesLoaded = 0;

    var tercih = loadImage('tercih.png', main);
    var wood1 = loadImage('wood1.jpg', main);
    var wood2 = loadImage('wood2.jpg', main);
    var wood3 = loadImage('wood3.jpg', main);
    var wood4 = loadImage('wood4.jpg', main);
    var img2 = loadImage('pusula.png', drawCanvas);
    var papers = loadImage('paper.png', drawCanvas);
    var kimlik = null;
    var kimlikResimde = false;
    var isimResimde = false;

    var secildi = false;

    document.addEventListener("DOMContentLoaded", function () {

        var imageLoader = document.getElementById('imageLoader');
        imageLoader.addEventListener('change', handleImage, false);

        canvas.addEventListener('click', function (evt) {

            var rect = canvas.getBoundingClientRect();
            var x = evt.clientX - rect.left;
            var y = evt.clientY - rect.top;

            console.log('x:' + x + ' y:' + y);
            var angle2 = Math.floor(Math.random() * 50);

            var isim = document.getElementById('isim').value;

            if (secildi == false) {
                /* tercih */
                stamp = new Img(x, y, 50, 50, angle2*Math.PI/180, true, tercih);
                stamp.drawFunc = function(){ drawPlain(stamp); };
                secildi = true;
            }
            else if (secildi == true && isim != '' && isimResimde == false) {
                /* name paper */
                var angle3 = Math.floor(Math.random() * 10);
                paper = new Img(x, y, 300, 100, angle3*Math.PI/180, true, papers);
                paper.drawFunc = function(){
                    drawShadow(paper, '#555555', 10);
                    ctx.save();
                    ctx.translate(paper.x, paper.y);
                    ctx.rotate(paper.angle);
                    ctx.font = '30px "AHundredMiles"';
                    var isim = document.getElementById('isim').value;
                    ctx.fillStyle = "#284283";
                    ctx.fillText(isim, 60, 60);
                    ctx.restore();
                };
                isimResimde = true;
            }
            else if (secildi == true && kimlik != null && kimlikResimde == false) {
                var angle3 = Math.floor(Math.random() * 30);
                idcard = new Img(x, y, 332, 450, angle3*Math.PI/180, true, kimlik);
                idcard.drawFunc = function(){ drawShadow(idcard, '#333333', 20); };
                kimlikResimde = true;
            }
        }, false);

        canvas.addEventListener('mousedown', function (evt) {
            var i;
            var rect = canvas.getBoundingClientRect();
            var canvasX = evt.clientX - rect.left;
            var canvasY = evt.clientY - rect.top;
            for (i=0; i<imgs.length; i++) {
                if (imgs[i].drag == false) continue;
                var rot = rotatePoint(canvasX - imgs[i].x, canvasY - imgs[i].y, imgs[i].angle*-1);
                var imageX = rot.x;
                var imageY = rot.y;
                if (imageX < 0 || imageX > imgs[i].w || imageY < 0 || imageY > imgs[i].h) continue; /* click is outside image */
                grab = {};
                grab.img = imgs[i];
                grab.origX = imgs[i].x;
                grab.origY = imgs[i].y;
                grab.origMouseX = evt.clientX;
                grab.origMouseY = evt.clientY;
            }
            drawCanvas();
        });
        
        canvas.addEventListener('mouseup', function (evt) {
            grab = null;
            drawCanvas();
        });
        
        canvas.addEventListener('mousemove', function (evt) {
            if (grab != null) {
                grab.img.x = grab.origX - (grab.origMouseX - evt.clientX);
                grab.img.y = grab.origY - (grab.origMouseY - evt.clientY);
                drawCanvas();
            }
        });
        drawCanvas();
    });

    var bastan = document.getElementById("bastan");
    bastan.addEventListener('click', function (evt) {
        imgs = [];
        secildi = false;
        kimlikResimde = false;
        isimResimde = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        main();
        drawCanvas();
    });

    var indir = document.getElementById("indir");

    function downloadCanvas(link, canvasId, filename) {
        link.href = document.getElementById(canvasId).toDataURL();
        link.download = filename;
    }

    indir.addEventListener('click', function (evt) {
        downloadCanvas(this, 'my-canvas', 'oy.png');
    });

    function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        var i;
        for(i=0; i<imgs.length; i++){
            imgs[i].drawFunc();
        }
    }

</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55638688-2', 'auto');
    ga('send', 'pageview');

</script>
</html>
